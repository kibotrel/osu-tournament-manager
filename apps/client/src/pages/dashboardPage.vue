<template>
  <div class="m-4">
    <p>
      Welcome {{ user.name }} ({{ user.gameUserId }}). Login:
      {{ user.isLoggedIn }}
    </p>
    <BaseButton class="w-24" @mousedown="logout" :isLoading="isPending">
      Logout
    </BaseButton>
    <input
      type="text"
      placeholder="Enter message..."
      v-model="message.content"
      @keydown.enter="
        () => {
          sendMessage(message, WebSocketChannelMatchesEvent.ChatMessages);
          message.content = '';
        }
      "
      class="my-2 rounded-md border border-gray-300 bg-inherit p-2"
    />
    <div class="mt-2 flex gap-2">
      <BaseButton @mousedown="connect">Connect</BaseButton>
      <BaseButton @mousedown="disconnect">Disconnect</BaseButton>
      <BaseButton
        @mousedown="
          () => {
            sendMessage(message, WebSocketChannelMatchesEvent.ChatMessages);
            message.content = '';
          }
        "
        >Send message</BaseButton
      >
    </div>
    <div class="my-2">
      <h1>Messages</h1>
      <p v-for="(entry, index) in history" :key="index">
        [{{ formatTimestamp(entry.timestamp) }}] ({{ entry.topic }})
        {{ entry.message.author }}:
        {{ entry.message.content }}
      </p>
    </div>
  </div>
</template>

<script setup lang="ts">
import type { WebSocketMessageMatch } from '@packages/shared';
import {
  WebSocketChannel,
  WebSocketChannelMatchesEvent,
  formatTimestamp,
} from '@packages/shared';
import { inject, reactive } from 'vue';
import type { Router } from 'vue-router';

import { useLogout } from '#src/api/authenticationApi.js';
import BaseButton from '#src/components/base/baseButton.vue';
import { useUserStore } from '#src/stores/userStore.js';
import { defineWebsocketStore } from '#src/stores/webSocketStore.js';

const $router = inject<Router>('$router');
const useWebSocketStore = defineWebsocketStore<
  WebSocketMessageMatch,
  WebSocketChannel.Matches
>({
  channel: WebSocketChannel.Matches,
  events: [WebSocketChannelMatchesEvent.ChatMessages],
  threadId: $router?.currentRoute.value.query.id as string,
});
const { isPending, mutate: logout } = useLogout();
const { user } = useUserStore();
const { connect, disconnect, history, sendMessage } = useWebSocketStore();
const message = reactive<WebSocketMessageMatch>({
  content: '',
  author: user.name,
});
</script>
